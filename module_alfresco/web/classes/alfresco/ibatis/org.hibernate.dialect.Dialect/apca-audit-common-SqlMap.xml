<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="alfresco.apca.audit">

    <!--                -->
    <!-- Type Defs      -->
    <!--                -->

    <typeAlias alias="ApcaAuditEntry" type="com.atolcd.apca.ApcaAuditEntry"/>
    <typeAlias alias="ApcaAuditCount" type="com.atolcd.apca.ApcaAuditCount"/>
    <typeAlias alias="ApcaAuditQueryParameters" type="com.atolcd.apca.ApcaAuditQueryParameters"/>


    <!--                -->
    <!-- Parameter Maps -->
    <!--                -->

    <parameterMap id="parameter_IdMap" class="long">
        <parameter property="id" jdbcType="BIGINT" javaType="long"/>
    </parameterMap>

    <!--                -->
    <!-- Result Maps    -->
    <!--                -->

    <resultMap id="result_ApcaAuditEntry" class="ApcaAuditEntry">
      <result property="id" column="id" jdbcType="BIGINT" javaType="long"/>
      <result property="auditUserId" column="audit_user_id" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditSite" column="audit_site" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditAppName" column="audit_app_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditActionName" column="audit_action_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditObject" column="audit_object" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditTime" column="audit_time" jdbcType="BIGINT" javaType="long"/>
    </resultMap>

    <resultMap id="results_ApcaAuditEntry" class="ApcaAuditEntry">
      <result property="id" column="id" jdbcType="BIGINT" javaType="long"/>
      <result property="auditUserId" column="audit_user_id" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditSite" column="audit_site" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditAppName" column="audit_app_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditActionName" column="audit_action_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditObject" column="audit_object" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditTime" column="audit_time" jdbcType="BIGINT" javaType="long"/>
    </resultMap>

    <resultMap id="results_ApcaAuditCount" class="ApcaAuditCount">
      <result property="count" column="audit_count" jdbcType="BIGINT" javaType="int"/>
      <result property="target" column="audit_target" jdbcType="VARCHAR" javaType="java.lang.String"/>
    </resultMap>
    <!--                -->
    <!-- SQL Snippets   -->
    <!--                -->

    <sql id="insert_ApcaAuditEntry_AutoIncrement">
        insert into apca_audit_entry (audit_user_id, audit_site, audit_app_name, audit_action_name, audit_object, audit_time)
        values (#auditUserId#,#auditSite#,#auditAppName#,#auditActionName#,#auditObject#,#auditTime#)
    </sql>

    <!-- Global select snippet -->
    <sql id="select_AuditEntriesWhereSnippet">
      <dynamic prepend="where">
          <isNotNull prepend="and" property="siteId">
              audit_site = #siteId#
          </isNotNull>
          <isNotNull prepend="and" property="appName">
              audit_app_name = #appName#
          </isNotNull>
          <isNotNull prepend="and" property="actionName">
              audit_action_name = #actionName#
          </isNotNull>
          <isGreaterThan prepend="and" property="dateFrom" compareValue="0">
              <![CDATA[audit_time >= #dateFrom#]]>
          </isGreaterThan>
          <isGreaterThan prepend="and" property="dateTo" compareValue="0">
              <![CDATA[audit_time < #dateTo#]]>
          </isGreaterThan>
          <isNotNull prepend="and" property="object">
             audit_object = #object#
          </isNotNull>
          <isNotNull prepend="and" property="userId">
             audit_user_id = #userId#
          </isNotNull>
      </dynamic>
    </sql>

    <!-- Views Snippet -->
    <sql id="select_auditViewEntriesWhereSnippet">
      where
        <![CDATA[audit_action_name <> "files-deleted"]]>
      and
        <![CDATA[audit_action_name <> "file-deleted"]]>
      and
        <![CDATA[audit_action_name <> "files-added"]]>
      and
        <![CDATA[audit_action_name <> "file-added"]]>
      and
        <![CDATA[audit_action_name <> "wiki-created"]]>
      <isNotNull prepend="and" property="siteId">
          audit_site = #siteId#
      </isNotNull>
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
      <include refid="time_snippet"/>
    </sql>

    <!-- Snippet de dates-->
    <sql id="time_snippet">
      <isGreaterThan prepend="and" property="dateFrom" compareValue="0">
        <![CDATA[audit_time >= #dateFrom#]]>
      </isGreaterThan>
      <isGreaterThan prepend="and" property="dateTo" compareValue="0">
        <![CDATA[audit_time < #dateTo#]]>
      </isGreaterThan>
    </sql>

    <!-- Snippet de consultation-->
    <sql id="view_snippet">
      where
      (
        audit_action_name = "page"
      or
        audit_action_name = "view"
      or
        audit_action_name = "library"
      or
        audit_action_name = "postlist"
      or
        audit_action_name = "postview"
      or
        audit_action_name = "lists"
      or
        audit_action_name = "topiclist"
      or
        audit_action_name = "topicview"
      or
        audit_action_name = "library"
      or
        audit_action_name = "calendar"
      or
        audit_action_name = ""
      )
      <isNotNull prepend="and" property="siteId">
          audit_site = #siteId#
      </isNotNull>
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
      <include refid="time_snippet"/>
    </sql>

    <!-- Snippet commentaires / réponses -->
    <sql id="comment_snippet">
      where
        audit_action_name = "comments"
      <isNotNull prepend="and" property="siteId">
          audit_site = #siteId#
      </isNotNull>
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
      <include refid="time_snippet" />
    </sql>

    <!-- Snippet d'opération sur fichiers -->
    <sql id="file_snippet">
      where
      (
        audit_action_name = "file-deleted"
      or
        audit_action_name = "file-added"
      )
      <isNotNull prepend="and" property="siteId">
          audit_site = #siteId#
      </isNotNull>
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
    </sql>

    <!--                -->
    <!-- Statements     -->
    <!--                -->


    <!-- Get the audit application by ID -->
    <select id="selectById" parameterMap="parameter_IdMap" resultMap="result_ApcaAuditEntry">
        select
            *
        from
            apca_audit_entry
        where
            id = ?
    </select>

    <!-- Get all audit records -->

    <select id="selectAll" resultMap="results_ApcaAuditEntry">
      select
        *
      from
        apca_audit_entry
    </select>


    <!-- Get stats about module -->
    <select id="selectModules" parameterClass="ApcaAuditQueryParameters" resultMap="results_ApcaAuditCount">
      select
        audit_app_name as audit_target, count(*) as audit_count
      from
        apca_audit_entry
      <include refid="select_AuditEntriesWhereSnippet"/>
      group by audit_target
    </select>

    <!-- Get stats about module views-->
    <select id="selectModuleViews" parameterClass="ApcaAuditQueryParameters" resultMap="results_ApcaAuditCount">
      select
        audit_app_name as audit_target, count(*) as audit_count
      from
        apca_audit_entry

      <include refid="view_snippet"/>
      <include refid="time_snippet" />
      group by audit_target
    </select>

    <!-- Get stats about action -->
    <select id="selectActions" parameterClass="ApcaAuditQueryParameters" resultMap="results_ApcaAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="select_auditViewEntriesWhereSnippet"/>
      group by audit_target
    </select>


    <!-- Get modules with comments & replies -->
    <select id="selectComments" parameterClass="ApcaAuditQueryParameters" resultMap="results_ApcaAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="comment_snippet" />

      group by audit_target
    </select>

    <!-- Get files activities -->
    <select id="selectFileActions" parameterClass="ApcaAuditQueryParameters" resultMap="results_ApcaAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="file_snippet" />
      <include refid="time_snippet" />
      group by audit_target
    </select>


    <!-- Get audit wihtin several sites -->
    <select id="selectViewsBySite" parameterClass="ApcaAuditQueryParameters" resultMap="results_ApcaAuditCount">
      select
        audit_site as audit_target, count(*) as audit_count
      from
        apca_audit_entry
      <include refid="view_snippet" />
      <include refid="time_snippet" />
      group by audit_target
    </select>

    <!-- Get audit wihtin several sites -->
    <select id="selectFilesBySite" parameterClass="ApcaAuditQueryParameters" resultMap="results_ApcaAuditCount">
      select
        audit_site as audit_target, count(*) as audit_count
      from
        apca_audit_entry
      <include refid="file_snippet" />
      <include refid="time_snippet" />
      group by audit_target
    </select>

    <!-- Get audit wihtin several sites -->
    <select id="selectCommentsBySite" parameterClass="ApcaAuditQueryParameters" resultMap="results_ApcaAuditCount">
      select
        audit_site as audit_target, count(*) as audit_count
      from
        apca_audit_entry
      <include refid="comment_snippet" />
      <include refid="time_snippet" />
      group by audit_target
    </select>


    <!-- Optimistic update of the audit application -->
    <update id="updateById" parameterClass="ApcaAuditEntry">
        update
            apca_audit_entry
        set
            audit_user_id = #auditUserId#,
            audit_site = #auditSite#,
            audit_app_name = #auditAppName#,
            audit_action_name = #auditActionName#,
            audit_object = #auditObject#
        where
            id = #id#
    </update>
</sqlMap>