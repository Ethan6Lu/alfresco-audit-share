<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="alfresco.atolcd.audit">

    <!--                -->
    <!-- Type Defs      -->
    <!--                -->

    <typeAlias alias="AtolAuditEntry" type="com.atolcd.alfresco.AuditEntry"/>
    <typeAlias alias="AtolCsvExportEntry" type="com.atolcd.alfresco.CsvExportEntry"/>
    <typeAlias alias="AtolAuditCount" type="com.atolcd.alfresco.AuditCount"/>
    <typeAlias alias="AtolAuditQueryParameters" type="com.atolcd.alfresco.AuditQueryParameters"/>
    <typeAlias alias="AtolAuditObjectPopularity" type="com.atolcd.alfresco.AuditObjectPopularity"/>


    <!--                -->
    <!-- Parameter Maps -->
    <!--                -->

    <parameterMap id="parameter_IdMap" class="long">
        <parameter property="id" jdbcType="BIGINT" javaType="long"/>
    </parameterMap>

    <!--                -->
    <!-- Result Maps    -->
    <!--                -->

    <resultMap id="result_AtolAuditEntry" class="AtolAuditEntry">
      <result property="id" column="id" jdbcType="BIGINT" javaType="long"/>
      <result property="auditUserId" column="audit_user_id" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditSite" column="audit_site" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditAppName" column="audit_app_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditActionName" column="audit_action_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditObject" column="audit_object" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditTime" column="audit_time" jdbcType="BIGINT" javaType="long"/>
    </resultMap>

    <resultMap id="results_AtolCsvExportEntry" class="AtolCsvExportEntry">
      <result property="auditSite" column="audit_site" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditAppName" column="audit_app_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditActionName" column="audit_action_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="count" column="audit_count" jdbcType="BIGINT" javaType="int"/>
    </resultMap>

    <resultMap id="results_AtolAuditCount" class="AtolAuditCount">
      <result property="count" column="audit_count" jdbcType="BIGINT" javaType="int"/>
      <result property="target" column="audit_target" jdbcType="VARCHAR" javaType="java.lang.String"/>
    </resultMap>
    
    <resultMap id="results_AtolAuditObjectPopularity" class="AtolAuditObjectPopularity">
      <result property="popularity" column="audit_popularity" jdbcType="BIGINT" javaType="int"/>
      <result property="auditObject" column="audit_object" jdbcType="VARCHAR" javaType="java.lang.String"/>
    </resultMap>

    <!--                -->
    <!-- SQL Snippets   -->
    <!--                -->

    <sql id="insert_AtolAuditEntry_AutoIncrement">
        insert into share_stats_audit_entry (audit_user_id, audit_site, audit_app_name, audit_action_name, audit_object, audit_time)
        values (#auditUserId#,#auditSite#,#auditAppName#,#auditActionName#,#auditObject#,#auditTime#)
    </sql>

    <!-- Global select snippet -->
    <sql id="select_AuditEntriesWhereSnippet">
      <dynamic prepend="where">
        <include refid="site_snippet"/>
        <include refid="time_snippet"/>
        <isNotNull prepend="and" property="appName">
            audit_app_name = #appName#
        </isNotNull>
        <isNotNull prepend="and" property="actionName">
            audit_action_name = #actionName#
        </isNotNull>
        <isNotNull prepend="and" property="object">
           audit_object = #object#
        </isNotNull>
        <isNotNull prepend="and" property="userId">
           audit_user_id = #userId#
        </isNotNull>
      </dynamic>
    </sql>

    <!-- Views Snippet -->
    <sql id="select_auditViewEntriesWhereSnippet">
      <dynamic prepend="where">
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
      <include refid="site_snippet"/>
      <include refid="time_snippet"/>
      </dynamic>
    </sql>

    <!-- Snippet de dates-->
    <sql id="time_snippet">
      <isGreaterThan prepend="and" property="dateFrom" compareValue="0">
        <![CDATA[audit_time >= #dateFrom#]]>
      </isGreaterThan>
      <isGreaterThan prepend="and" property="dateTo" compareValue="0">
        <![CDATA[audit_time < #dateTo#]]>
      </isGreaterThan>
    </sql>

    <!-- Snippet pour sites -->
    <sql id="site_snippet">
      <isNotNull prepend="and" property="siteId">
          audit_site = #siteId#
      </isNotNull>
      <isNotNull prepend="and" property="sitesId">
        audit_site
        <iterate open="IN (" close=")" conjunction="," property="sitesId">
          #sitesId[]#
        </iterate>
      </isNotNull>
    </sql>


    <!-- Snippet de consultation-->
    <sql id="read_snippet">
      <dynamic prepend="where">
        <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
        </isNotNull>
        <isEqual prepend="and" property="appName" compareValue="document">
          (
            audit_action_name = "details"
          or
            audit_action_name = "download"
          )
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="wiki">
          (
            audit_action_name = "page"
          or
            audit_action_name = "view"
          )
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="blog">
          (
            audit_action_name = "postview"
          or
            audit_action_name = "postlist"
          )
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="discussions">
          (
            audit_action_name = "topicview"
          or
            audit_action_name = "topiclist"
          )
        </isEqual>
        <include refid="time_snippet" />
        <include refid="site_snippet"/>
      </dynamic>
    </sql>


    <!-- Snippet de création -->
    <sql id="create_snippet">
      <dynamic prepend="where">
        <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
        </isNotNull>
        <isEqual prepend="and" property="appName" compareValue="document">
          (
            audit_action_name = "file-added"
          or
            audit_action_name = "create"
          )
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="wiki">
            audit_action_name = "create-post"
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="blog">
            audit_action_name = "blog-create"
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="discussions">
            audit_action_name = "discussions-create"
        </isEqual>
      <include refid="time_snippet" />
      <include refid="site_snippet"/>
      </dynamic>
    </sql>

    <!-- Snippet de mise à jour -->
    <sql id="update_snippet">
      <dynamic prepend="where">
        <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
        </isNotNull>
        <isEqual prepend="and" property="appName" compareValue="document">
          (
            audit_action_name = "update"
          or
            audit_action_name = "file-updated"
          or
            audit_action_name = "inline-edit"
          )
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="wiki">
          audit_action_name = "update-post"
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="blog">
          audit_action_name = "blog-update"
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="discussions">
          audit_action_name = "discussions-update"
        </isEqual>
      <include refid="time_snippet" />
      <include refid="site_snippet"/>
      </dynamic>
    </sql>

    <!-- Snippet de suppression -->
    <sql id="delete_snippet">
      <dynamic prepend="where">
        <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
        </isNotNull>
        <isEqual prepend="and" property="appName" compareValue="document">
            audit_action_name = "file-deleted"
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="wiki">
            audit_action_name = "delete-post"
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="blog">
            audit_action_name = "blog-deleted"
        </isEqual>
        <isEqual prepend="and" property="appName" compareValue="discussions">
            audit_action_name = "discussions-deleted"
        </isEqual>
      <include refid="time_snippet" />
      <include refid="site_snippet"/>
      </dynamic>
    </sql>
    <!--                -->
    <!-- Statements     -->
    <!--                -->


    <!-- Get the audit application by ID -->
    <select id="selectById" parameterMap="parameter_IdMap" resultMap="result_AtolAuditEntry">
        select
            *
        from
            share_stats_audit_entry
        where
            id = ?
    </select>

    <!-- Get all audit records -->

    <select id="selectAll" resultMap="results_AtolCsvExportEntry">
      select
        audit_site,
        count(*) as audit_count,
        audit_app_name,
        audit_action_name
      from
        share_stats_audit_entry
      <include refid="select_AuditEntriesWhereSnippet"/>
      group by audit_site, audit_app_name, audit_action_name
      order by audit_site, audit_app_name, audit_action_name
    </select>

    <select id="selectByRead" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="read_snippet"/>
      group by audit_target
    </select>

    <select id="selectByUpdated" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="update_snippet"/>
      group by audit_target
    </select>

    <select id="selectByCreated" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="create_snippet"/>
      group by audit_target
    </select>

    <select id="selectByDeleted" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="delete_snippet"/>
      group by audit_target
    </select>
    
    <select id="selectByMostUpdated" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      select
        count(*) as audit_popularity, audit_object
      from
        share_stats_audit_entry
      where
        audit_app_name = 'document'
      and
      (
          audit_action_name ='update'
        or
          audit_action_name ='file-updated'
        or
          audit_action_name ='inline-updated'
      )
      <include refid="site_snippet"/>
      group by audit_object
      order by audit_popularity DESC
    </select>
    
    <select id="selectByMostRead" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      select
        count(*) as audit_popularity, audit_object
      from
        share_stats_audit_entry
      where
        audit_app_name = 'document'
      and
      (
          audit_action_name ='details'
        or
          audit_action_name ='download'
      )
      <include refid="site_snippet"/>
      group by audit_object
      order by audit_popularity DESC
    </select>
</sqlMap>