<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="alfresco.atolcd.audit">

    <!--                -->
    <!-- Type Defs      -->
    <!--                -->

    <typeAlias alias="AtolAuditEntry" type="com.atolcd.alfresco.AuditEntry"/>
    <typeAlias alias="AtolAuditCount" type="com.atolcd.alfresco.AuditCount"/>
    <typeAlias alias="AtolAuditQueryParameters" type="com.atolcd.alfresco.AuditQueryParameters"/>


    <!--                -->
    <!-- Parameter Maps -->
    <!--                -->

    <parameterMap id="parameter_IdMap" class="long">
        <parameter property="id" jdbcType="BIGINT" javaType="long"/>
    </parameterMap>

    <!--                -->
    <!-- Result Maps    -->
    <!--                -->

    <resultMap id="result_AtolAuditEntry" class="AtolAuditEntry">
      <result property="id" column="id" jdbcType="BIGINT" javaType="long"/>
      <result property="auditUserId" column="audit_user_id" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditSite" column="audit_site" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditAppName" column="audit_app_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditActionName" column="audit_action_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditObject" column="audit_object" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditTime" column="audit_time" jdbcType="BIGINT" javaType="long"/>
    </resultMap>

    <resultMap id="results_AtolAuditEntry" class="AtolAuditEntry">
      <result property="id" column="id" jdbcType="BIGINT" javaType="long"/>
      <result property="auditUserId" column="audit_user_id" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditSite" column="audit_site" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditAppName" column="audit_app_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditActionName" column="audit_action_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditObject" column="audit_object" jdbcType="VARCHAR" javaType="java.lang.String"/>
      <result property="auditTime" column="audit_time" jdbcType="BIGINT" javaType="long"/>
    </resultMap>

    <resultMap id="results_AtolAuditCount" class="AtolAuditCount">
      <result property="count" column="audit_count" jdbcType="BIGINT" javaType="int"/>
      <result property="target" column="audit_target" jdbcType="VARCHAR" javaType="java.lang.String"/>
    </resultMap>
    <!--                -->
    <!-- SQL Snippets   -->
    <!--                -->

    <sql id="insert_AtolAuditEntry_AutoIncrement">
        insert into share_stats_audit_entry (audit_user_id, audit_site, audit_app_name, audit_action_name, audit_object, audit_time)
        values (#auditUserId#,#auditSite#,#auditAppName#,#auditActionName#,#auditObject#,#auditTime#)
    </sql>

    <!-- Global select snippet -->
    <sql id="select_AuditEntriesWhereSnippet">
      <dynamic prepend="where">
        <include refid="site_snippet"/>
        <include refid="time_snippet"/>
        <isNotNull prepend="and" property="appName">
            audit_app_name = #appName#
        </isNotNull>
        <isNotNull prepend="and" property="actionName">
            audit_action_name = #actionName#
        </isNotNull>
        <isNotNull prepend="and" property="object">
           audit_object = #object#
        </isNotNull>
        <isNotNull prepend="and" property="userId">
           audit_user_id = #userId#
        </isNotNull>
      </dynamic>
    </sql>

    <!-- Views Snippet -->
    <sql id="select_auditViewEntriesWhereSnippet">
      <dynamic prepend="where">
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
      <include refid="site_snippet"/>
      <include refid="time_snippet"/>
      </dynamic>
    </sql>

    <!-- Snippet de dates-->
    <sql id="time_snippet">
      <isGreaterThan prepend="and" property="dateFrom" compareValue="0">
        <![CDATA[audit_time >= #dateFrom#]]>
      </isGreaterThan>
      <isGreaterThan prepend="and" property="dateTo" compareValue="0">
        <![CDATA[audit_time < #dateTo#]]>
      </isGreaterThan>
    </sql>

    <!-- Snippet pour sites -->
    <sql id="site_snippet">
      <isNotNull prepend="and" property="siteId">
          audit_site = #siteId#
      </isNotNull>
      <isNotNull prepend="and" property="sitesId">
        audit_site
        <iterate open="IN (" close=")" conjunction="," property="sitesId">
          #sitesId[]#
        </iterate>
      </isNotNull>
    </sql>


    <!-- Snippet de consultation-->
    <sql id="view_snippet">
      where
      (
        audit_action_name in
          ("page","view","details","postlist","postview","lists","topiclist","topicview","members","groups")
      or
        <![CDATA[(audit_app_name = "calendar" and audit_action_name <> "create")]]>
      or
        <![CDATA[(audit_app_name = "search" and audit_action_name <> "query")]]>
      )
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
      <include refid="time_snippet" />
      <include refid="site_snippet"/>
    </sql>

    <!-- Snippet commentaires / réponses -->
    <sql id="comment_snippet">
      where
        audit_action_name = "comments"
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
      <include refid="time_snippet" />
      <include refid="site_snippet"/>
    </sql>

    <!-- Snippet d'opération sur fichiers -->
    <sql id="file_snippet">
      where
      (
        audit_action_name = "file-deleted"
      or
        audit_action_name = "file-added"
      or
        audit_action_name = "download"
      )
      <isNotNull prepend="and" property="appName">
          audit_app_name = #appName#
      </isNotNull>
      <include refid="time_snippet" />
      <include refid="site_snippet"/>
    </sql>

    <!--                -->
    <!-- Statements     -->
    <!--                -->


    <!-- Get the audit application by ID -->
    <select id="selectById" parameterMap="parameter_IdMap" resultMap="result_AtolAuditEntry">
        select
            *
        from
            share_stats_audit_entry
        where
            id = ?
    </select>

    <!-- Get all audit records -->

    <select id="selectAll" resultMap="results_AtolAuditEntry">
      select
        *
      from
        share_stats_audit_entry
      <include refid="select_AuditEntriesWhereSnippet"/>
    </select>


    <!-- Get stats about module -->
    <select id="selectModules" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      select
        audit_app_name as audit_target, count(*) as audit_count
      from
        share_stats_audit_entry
      <include refid="select_AuditEntriesWhereSnippet"/>
      group by audit_target
    </select>

    <!-- Get stats about module views-->
    <select id="selectModuleViews" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      select
        audit_app_name as audit_target, count(*) as audit_count
      from
        share_stats_audit_entry

      <include refid="view_snippet"/>
      group by audit_target
    </select>

    <!-- Get stats about action -->
    <select id="selectActions" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="select_auditViewEntriesWhereSnippet"/>
      group by audit_target
    </select>


    <!-- Get modules with comments & replies -->
    <select id="selectComments" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="comment_snippet" />
      group by audit_target
    </select>

    <!-- Get files activities -->
    <select id="selectFileActions" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      <include refid="select_concat_actions"/>
      <include refid="file_snippet" />
      group by audit_target
    </select>


    <!-- Get audit wihtin several sites -->
    <select id="selectViewsBySite" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      select
        audit_site as audit_target, count(*) as audit_count
      from
        share_stats_audit_entry
      <include refid="view_snippet" />
      group by audit_target
    </select>

    <!-- Get audit wihtin several sites -->
    <select id="selectFilesBySite" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      select
        audit_site as audit_target, count(*) as audit_count
      from
        share_stats_audit_entry
      <include refid="file_snippet" />
      group by audit_target
    </select>

    <!-- Get audit wihtin several sites -->
    <select id="selectCommentsBySite" parameterClass="AtolAuditQueryParameters" resultMap="results_AtolAuditCount">
      select
        audit_site as audit_target, count(*) as audit_count
      from
        share_stats_audit_entry
      <include refid="comment_snippet" />
      group by audit_target
    </select>
</sqlMap>