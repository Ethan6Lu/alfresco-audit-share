<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING/DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>
  <import resource="classpath:alfresco/module/share-stats-module-alfresco/context/schedulers-context.xml" />

  <bean name="shareStatsConfigProperties" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="ignoreUnresolvablePlaceholders">
      <value>true</value>
    </property>
    <property name="locations">
      <list>
        <value>classpath:alfresco/module/share-stats-module-alfresco/share-stats-config.properties</value>
      </list>
    </property>
  </bean>

  <!-- iBatis config for Alfresco (using common datasource) -->
  <bean id="shareStatsAlfrescoSqlMapClient" class="org.alfresco.ibatis.HierarchicalSqlMapClientFactoryBean">
      <property name="dataSource" ref="dataSource"/>
      <property name="resourceLoader" ref="dialectResourceLoader" />
      <property name="useTransactionAwareDataSource" value="false" />
      <property name="configLocation">
          <value>classpath:alfresco/module/share-stats-module-alfresco/ibatis/share-stats-SqlMapConfig.xml</value>
      </property>
  </bean>

  <bean id="alfrescoShareStatsResourceBundles" class="org.alfresco.i18n.ResourceBundleBootstrapComponent">
    <property name="resourceBundles">
      <list>
        <value>alfresco.module.share-stats-module-alfresco.messages.share-stats</value>
      </list>
    </property>
  </bean>

  <bean id="shareStatsQueriesSqlMapClientTemplate" class="org.springframework.orm.ibatis.SqlMapClientTemplate">
      <property name="sqlMapClient" ref="shareStatsAlfrescoSqlMapClient"/>
  </bean>

  <!-- Webscripts - Audit Queries -->
  <bean id="webscript.com.atolcd.alfresco.share-stats.insert-audit.post" class="com.atolcd.alfresco.web.scripts.shareStats.InsertAuditPost" parent="webscript">
    <property name="sqlMapClientTemplate" ref="shareStatsQueriesSqlMapClientTemplate"/>
    <property name="siteService" ref="SiteService" />
  </bean>

  <bean id="webscript.com.atolcd.alfresco.share-stats.select-audits.get" class="com.atolcd.alfresco.web.scripts.shareStats.SelectAuditsGet" parent="webscript">
    <property name="sqlMapClientTemplate" ref="shareStatsQueriesSqlMapClientTemplate"/>
    <property name="nodeService" ref="NodeService"/>
  </bean>

  <bean id="webscript.com.atolcd.alfresco.share-stats.select-users.get" class="com.atolcd.alfresco.web.scripts.shareStats.SelectUsersGet" parent="webscript">
    <property name="sqlMapClientTemplate" ref="shareStatsQueriesSqlMapClientTemplate"/>
    <property name="nodeService" ref="NodeService"/>
    <property name="siteService" ref="SiteService" />
  </bean>

  <bean id="webscript.com.atolcd.alfresco.share-stats.select-volumetry.get" class="com.atolcd.alfresco.web.scripts.shareStats.SelectVolumetryGet" parent="webscript">
    <property name="sqlMapClientTemplate" ref="shareStatsQueriesSqlMapClientTemplate"/>
  </bean>

  <bean id="webscript.com.atolcd.alfresco.share-stats.export-audits.get" class="com.atolcd.alfresco.web.scripts.shareStats.AuditExportGet" parent="webscript">
    <property name="wsSelectAudits">
      <ref bean="webscript.com.atolcd.alfresco.share-stats.select-audits.get" />
    </property>
    <property name="siteService" ref="SiteService" />
  </bean>

	<!-- JavaScript API -->
  <bean id="shareStatsScript" parent="baseJavaScriptExtension" class="com.atolcd.alfresco.repo.jscript.ShareStats">
    <property name="extensionName">
      <value>sharestats</value>
    </property>
    <property name="wsInsertAudits">
      <ref bean="webscript.com.atolcd.alfresco.share-stats.insert-audit.post" />
    </property>
  </bean>

  <!-- Patch de création de la table d'audit en base -->
  <bean id="patch.db-V3.4-ShareStats-ExtraTables" class="com.atolcd.alfresco.repo.patch.SchemaUpgradeScriptPatch" parent="module.baseComponent" >
    <property name="moduleId" value="share-stats-module-alfresco" />
    <property name="name" value="Création des tables d'audit concernant les statistiques des sites Share" />
    <property name="description" value="" />
    <property name="executeOnceOnly" value="true" />

    <property name="dataSource">
      <ref bean="dataSource"/>
    </property>
    <property name="localSessionFactory">
      <ref bean="&amp;sessionFactory"></ref>
    </property>
    <property name="dialect">
      <ref bean="dialect" />
    </property>
    <property name="globalProperties">
      <ref bean="global-properties" />
    </property>
    <property name="scriptUrl">
      <value>classpath:alfresco/module/share-stats-module-alfresco/dbscripts/create/${db.script.dialect}/AlfrescoCreate-ShareStatsAuditTables.sql</value>
    </property>
  </bean>
</beans>